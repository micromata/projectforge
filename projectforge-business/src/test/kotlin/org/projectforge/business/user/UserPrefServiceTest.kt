/////////////////////////////////////////////////////////////////////////////
//
// Project ProjectForge Community Edition
//         www.projectforge.org
//
// Copyright (C) 2001-2025 Micromata GmbH, Germany (www.micromata.com)
//
// ProjectForge is dual-licensed.
//
// This community edition is free software; you can redistribute it and/or
// modify it under the terms of the GNU General Public License as published
// by the Free Software Foundation; version 3 of the License.
//
// This community edition is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
// Public License for more details.
//
// You should have received a copy of the GNU General Public License along
// with this program; if not, see http://www.gnu.org/licenses/.
//
/////////////////////////////////////////////////////////////////////////////

package org.projectforge.business.user

import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.Test
import org.projectforge.business.user.service.UserPrefService
import org.projectforge.framework.utils.NumberHelper
import org.projectforge.business.test.AbstractTestBase
import org.springframework.beans.factory.annotation.Autowired

class UserPrefServiceTest : AbstractTestBase() {
    @Autowired
    private lateinit var userPrefCache: UserPrefCache

    @Autowired
    private lateinit var userPrefDao: UserPrefDao

    @Autowired
    private lateinit var userPrefService: UserPrefService

    @Test
    fun entriesTest() {
        logon(TEST_USER)
        val area = "UserPrefCacheTest"
        val name = NumberHelper.getSecureRandomAlphanumeric(20)
        val name2 = NumberHelper.getSecureRandomAlphanumeric(20)
        val entry = userPrefService.getEntry(area, name, String::class.java)
        assertNull(entry)
        userPrefService.putEntry(area, name, "Hurzel")
        userPrefService.putEntry(area, name2, 42)
        assertEquals("Hurzel", userPrefService.getEntry(area, name, String::class.java))
        logoff()
        logon(TEST_USER2)
        assertNull(userPrefService.getEntry(area, name, String::class.java))
        userPrefService.putEntry(area, name, "Hurzel2")
        userPrefService.putEntry(area, name2, 88)
        logoff()
        suppressErrorLogs {
            userPrefCache.flushToDB(getUserId(TEST_USER)) // User 'null' is not allowed.
        }
        userPrefCache.setExpired()
        logon(TEST_USER)
        assertEquals("Hurzel", userPrefService.getEntry(area, name, String::class.java))
        assertEquals(42, userPrefService.getEntry(area, name2, Int::class.java))
        logon(TEST_USER2)
        assertEquals("Hurzel2", userPrefService.getEntry(area, name, String::class.java))
        assertEquals(88, userPrefService.getEntry(area, name2, Int::class.java))
        userPrefCache.flushToDB(getUserId(TEST_USER2))
        val prefNames = userPrefDao.getPrefNames(area)
        assertEquals(2, prefNames.size, "Got prefnames ${prefNames.joinToString { it }}")
        assertTrue(prefNames.contains(name))
        assertTrue(prefNames.contains(name2))

        logon(TEST_USER)
        var prefs = userPrefDao.selectUserPrefs(getUserId(TEST_USER))
        //println(ToStringUtil.toJsonString(prefs))
        assertEquals("^JSON:\"Hurzel\"", prefs.find { it.area == area && it.name == name }!!.serializedValue)
        assertEquals("^JSON:42", prefs.find { it.area == area && it.name == name2 }!!.serializedValue)

        logon(TEST_USER2)
        userPrefCache.flushToDB(getUserId(TEST_USER2))
        prefs = userPrefDao.selectUserPrefs(getUserId(TEST_USER2))
        assertEquals("^JSON:\"Hurzel2\"", prefs.find { it.area == area && it.name == name }!!.serializedValue)
        assertEquals("^JSON:88", prefs.find { it.area == area && it.name == name2 }!!.serializedValue)
        //println(ToStringUtil.toJsonString(userPrefDao.getUserPrefs(getUserId(TEST_USER2))))
        val longValue = "a".repeat(1500)
        userPrefService.putEntry(area, name, longValue)
        userPrefCache.flushToDB(getUserId(TEST_USER2))
        userPrefService.putEntry(area, name, longValue)
        userPrefCache.flushToDB(getUserId(TEST_USER2))
        prefs = userPrefDao.selectUserPrefs(getUserId(TEST_USER2))
        val serializedValue = prefs.find { it.area == area && it.name == name }!!.serializedValue!!
        assertTrue(serializedValue.startsWith("!"), "Serialized value should start with '!': $serializedValue")
    }
}
